<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Nightingale's Rose</title>
		<!-- Stylesheets -->
		<link href='http://fonts.googleapis.com/css?family=Cabin:500' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" type="text/css" href="reset.css">
		<link rel="stylesheet" type="text/css" href="style.css">
		<!-- Libraries -->
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
		<!-- Scripts -->
		<script type="text/javascript" src="script.js"></script>
	</head>
	<body>
		<!--<h1>Nightingale's Rose</h1>-->
		<!-- Inspiration: http://mbostock.github.io/protovis/ex/crimea-rose.html http://understandinguncertainty.org/node/213 http://bl.ocks.org/kgryte/5926740
		-->
		<script type="text/javascript">
			var rose = Chart.rose(),
				height = 600,
				format = d3.time.format('%B'),
				causes = ['Direct', 'Agency', 'Air Crews'];//,
				labels = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

			// Add a title:
			d3.select('body').append('h2')
				.attr('class', 'title')
				.html('Diagram <span class="small">of the</span> Data Analysis <span class="small">of</span> Hotel Customers');

			// Add sub-titles:
			d3.select('body').append('h3')
				.attr('class', 'subtitle left')
				.html('Reservation');

			/*d3.select('body').append('h3')
				.attr('class', 'subtitle right')
				.html('April 1854 - March 1855');
				*/
			// Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 70, left: 50},
    width = 600 - margin.left - margin.right,
    height = 270 - margin.top - margin.bottom;

// Parse the date / time
var parseDate = d3.time.format("%B").parse;

// Set the ranges
var x = d3.time.scale().range([0, width]);
var y = d3.scale.linear().range([height, 0]);

// Define the axes
var xAxis = d3.svg.axis().scale(x)
    .orient("bottom").ticks(10)
    .tickFormat(d3.time.format("%B")); // tickFormat

var yAxis = d3.svg.axis().scale(y)
    .orient("left").ticks(5);

// Define the line
var valueline = d3.svg.line()
    .x(function(d) { return x(parseDate(d.label)); })
    .y(function(d) { return y(d.price); });
    
// Adds the svg canvas
var svg = d3.select("body")
    .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");

			// Load the csv data:
			d3.csv('hotel.csv', type, function(error, data) {
				// Format the date and rework the data:
				if (error)throw error;
				
				var scalar;
				data.forEach(function(d, i) { 
					//d.date = format.parse(i);
					d.label = d.label;//labels[d.date.getMonth()];
					
					// Calculate the average annual mortality, as done by Nightingale:
					// http://understandinguncertainty.org/node/214 
					scalar = d.occupancy;
					d.DR = d.DR * scalar;
					d.agency  = d.agency  * scalar;
					d.AC   = d.AC   * scalar;
				});

				// Get the maximum value:
				var maxVal = d3.max(data, function(d) {
					return d3.max([d.DR, d.agency, d.AC]);
				});

				// Where the maximum value gives us the maximum radius:
				var maxRadius = Math.sqrt(maxVal*12 / Math.PI);

				// Divide the dataset in two:
				/*var dataset2 = data.slice(12,24),
					dataset1 = data.slice(0,12);
				*/
				var dataset1 = data, dataset2 = data;
				// Append a new figure to the DOM:
				figure = d3.select('body')
					.append('figure');

				// Get the figure width:
				width = parseInt(figure.style('width'), 10);

				// Update the chart generator settings:
				rose.legend(causes)
					.width(width)
					.height(height)
					.delay(0)
					.duration(500)
					.domain([0, maxRadius])
					.angle(function(d, i) { return i; })
					.area(function(d, i) { return [d.DR, d.agency, d.AC]; });							

				// Bind the data and generate a new chart:
				figure.datum(dataset1)
					.attr('class', 'chart figure1')
					.call(rose);	

				// Append a new figure to the DOM:
				figure = d3.select('body')
					.append('figure');

				// Get the figure width:
				width = parseInt(figure.style('width'), 10);

				// Update the chart generator settings:
				rose.width(width)
					.delay(3000);

				// Bind the second dataset and generate a new chart:
				/*figure.datum(dataset2)
					.attr('class', 'chart figure2')
					.call(rose);	
*/
				// Append a caption:
				/*d3.select('.figure2').append('figcaption')
					.attr('class', 'caption')
					.html('The Areas of the blue, red, &amp; black wedges are each measured from the centre as the common vertex <p> The blue wedges measured from the centre of the circle represent area for area the deaths from Preventible or Mitigable Zymotic Diseases, the red wedges measured from the center the deaths from wounds, &amp; the black wedges measured from the center the deaths from all other causes </p><p> In October 1844, &amp; April 1855, the black area coincides with the red, in January &amp; February 1856, the blue coincides with the black </p><p> The entire areas may be compared by following the blue, the red &amp; the black lines enclosing them.</p>');
*/
				// Create a legend:
				Chart.legend(causes);

				// Create a slider:
				Chart.slider(0, data.length, 1); // minVal, maxVal, step
				
				// Scale the range of the data
    x.domain(d3.extent(data, function(d) { return parseDate(d.label); }));
    y.domain([0, d3.max(data, function(d) { return d.price; })]);

    // Add the valueline path.
    svg.append("path")
        .attr("class", "line")
        .attr("d", valueline(data));

    // Add the X Axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .selectAll("text")	
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                return "rotate(-65)" 
                });

    // Add the Y Axis
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);
			});	
			
			function type(d) {
      			d.female = +d.female;
      			d.local = +d.local;
      			d.USA = +d.USA;
      			d.SA = +d.SA;
      			d.EU = +d.EU;
      			d.EU = +d.EU;
      			d.MEA = +d.MEA;
      			d.ASIA = +d.ASIA;
      			d.businessmen = +d.businessmen;
				d.tourists = +d.tourists;
      			d.DR = +d.DR;
      			d.agency = +d.agency;
      			d.AC = +d.AC
      			d.u20 = +d.u20;
				d.f20to35 = +d.f20to35;
				d.f35to55 = +d.f35to55;
				d.m55 = +d.m55;
				d.price = +d.price;
				d.LoS = +d.LoS;
				d.occupancy = +d.occupancy;
				d.conventions = +d.conventions;
      			return d;
    		}
			
		</script>
		
		<!-- stacked area chart-->
	<!--	<script>

			var margin = {top: 20, right: 20, bottom: 30, left: 50},
    			width = 960 - margin.left - margin.right,
    			height = 500 - margin.top - margin.bottom;

			var parseDate = d3.time.format("%y-%b-%d").parse,
    			formatPercent = d3.format(".0%");

			var x = d3.time.scale()
    			.range([0, width]);

			var y = d3.scale.linear()
    			.range([height, 0]);

			var color = d3.scale.category20();

			var xAxis = d3.svg.axis()
   			 	.scale(x)
    			.orient("bottom");

			var yAxis = d3.svg.axis()
    			.scale(y)
    			.orient("left")
    			.tickFormat(formatPercent);

			var area = d3.svg.area()
    			.x(function(d) { return x(d.date); })
    			.y0(function(d) { return y(d.y0); })
    			.y1(function(d) { return y(d.y0 + d.y); });

			var stack = d3.layout.stack()
    			.values(function(d) { return d.values; });

			var svg = d3.select("body").append("svg")
    			.attr("width", width + margin.left + margin.right)
    			.attr("height", height + margin.top + margin.bottom)
  			.append("g")
    			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			d3.csv("hotel.csv", function(error, data) {
  				if (error) throw error;

  				color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

  				data.forEach(function(d) {
    				d.date = parseDate(d.date);
  				});

  				var regions = stack(color.domain().map(function(name) {
   		 			return {
      					name: name,
      					values: data.map(function(d) {
        				return {date: d.date, y: d[name] / 100};
      				})
    			};
  			}));

  			x.domain(d3.extent(data, function(d) { return d.date; }));

  			var region = svg.selectAll(".region")
      			.data(regions)
    			.enter().append("g")
      			.attr("class", "region");

  			region.append("path")
      			.attr("class", "area")
      			.attr("d", function(d) { return area(d.values); })
      			.style("fill", function(d) { return color(d.name); });

  			region.append("text")
      			.datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      			.attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.y0 + d.value.y / 2) + ")"; })
      			.attr("x", -6)
      			.attr("dy", ".35em")
      			.text(function(d) { return d.name; });

  			svg.append("g")
      			.attr("class", "x axis")
      			.attr("transform", "translate(0," + height + ")")
      			.call(xAxis);

  			svg.append("g")
      			.attr("class", "y axis")
      			.call(yAxis);
			});

		</script> -->
		
	</body>

</html>